/*
**	Copyright (c) 1986, 2004 Ingres Corporation
*/

# include	<compat.h>
# include	<gl.h>
# include	<sl.h>
# include	<iicommon.h>
# include	<fe.h>
#include "ioistd.h"
#include <ds.h>
#include <feds.h>
#include <ifrmobj.h>

/**
** Name:	ioifrm.c - write frames
**
** Description:
**	image file frame write.
**
**  History:
**	10/14/92 (dkh) - Removed use of ArrayOf in favor of DSTARRAY.
**			 ArrayOf confused the alpha C compiler.
**      07-May-96 (fanra01)
**          bug# 76270
**          Added a call to frm_init which initialises the template structure.
**          This call has been added to facilitate the initialisation of
**          the template structure with items which are not constant at compile
**          time.
**      29-apr-1999 (hanch04)
**          Changed ftell to return offset.
**      03-jun-1999 (hanch04)
**          Change SIfseek to use OFFSET_TYPE and LARGEFILE64 for files > 2gig
*/

#ifdef PCINGRES
extern bool ME_recoverable;
#endif

GLOBALREF DSTARRAY Frm_template;

/*{
** Name:	IIOIfwFrmWrite -  write frame.
**
** Description:
**	Write frame to open image file.  Will seek to end, then write,
**	returning position to caller.
**
** Inputs:
**	fp	image file
**	frm	frame to write
**
** Outputs:
**	pos	file position
**
**	return:
**		OK		success
**
** Side Effects:
**
** History:
**	9/86 (rlm)	written
**      07-May-96 (fanra01)
**          Added a call to frm_init which initialises the template structure.
**
*/

STATUS
IIOIfwFrmWrite(ohdr, frm, pos)
OLIMHDR	*ohdr;
IFRMOBJ	*frm;
i4	*pos;
{
	SH_DESC	sh_desc;
	FILE	*fp;
	STATUS	rc;
	OFFSET_TYPE offset;

#	ifdef PCINGRES
	bool	oldreco;
#	endif

        frm_init();
	fp = ohdr->fp;

	if (SIfseek(fp,0L,SI_P_END) != OK)
		return (ILE_FRDWR);
	offset = SIftell(fp);
	*pos = offset;

	sh_desc.sh_type = IS_RACC;
	sh_desc.sh_reg.file.fp = fp;
	sh_desc.sh_dstore = TRUE;

	/*
	** For PCINGRES, DSstore call is bracketed with flag setting for ME
	** to handle allocation failure.  This flag allows DS to handle
	** an exception generated by ME, rather than causing a syserr()
	*/
#	ifdef PCINGRES
		oldreco = ME_recoverable;
		ME_recoverable = TRUE;
		rc = DSstore(&sh_desc, (i4)DS_OIFRM, (i4)frm, &Frm_template);
		ME_recoverable = oldreco;
#	else
		rc = DSstore(&sh_desc, (i4)DS_OIFRM, (PTR)frm, &Frm_template);
#	endif

	switch ((int) rc)
	{
	case OK:
		break;
# ifdef PCINGRES
	case ME_GONE:
		return (ILE_NOMEM);
# endif
	default:
		return (ILE_FRDWR);
	}

	return (OK);
}
